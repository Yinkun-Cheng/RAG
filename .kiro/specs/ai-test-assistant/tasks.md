# 实施计划：AI 测试助手

## 概述

本实施计划将 AI 测试助手系统分解为离散的、增量的编码任务。系统将分阶段构建，从核心基础设施开始，然后添加 Agent/Skills/Tools 层，最后集成前端。每个任务都建立在之前的工作基础上，以确保持续集成和验证。

## 任务

- [x] 1. 搭建 Python AI 服务基础设施
  - 创建 Python AI 服务的项目结构
  - 使用 CORS 和中间件设置 FastAPI 应用
  - 配置 API 密钥的环境变量（BRConnector、火山引擎）
  - 实现健康检查端点
  - 设置日志配置
  - 为 Python 服务创建 Docker 配置
  - _需求: 2.1, 2.2, 2.3, 10.1, 10.2_

- [x] 1.1 为 FastAPI 设置编写单元测试
  - 测试健康检查端点
  - 测试 CORS 配置
  - 测试环境变量加载
  - _需求: 2.3, 2.4_

- [x] 2. 实现集成服务（BRConnector、Embedding、Weaviate）
  - [x] 2.1 实现 Claude API 的 BRConnectorClient
    - 创建带重试逻辑的异步客户端
    - 实现支持流式传输的 chat 方法
    - 添加 API 错误和速率限制的错误处理
    - _需求: 6.1, 6.2, 6.3, 6.4_
  
  - [x] 2.2 为 BRConnectorClient 编写单元测试
    - 测试成功的 API 调用
    - 测试失败时的重试逻辑
    - 测试速率限制处理
    - _需求: 6.3, 6.4_
  
  - [x]* 2.3 实现 VolcanoEmbeddingService（可选 - 已通过 Go 后端）
    - 创建用于 embedding 生成的异步客户端
    - 实现单个和批量 embedding 方法
    - 添加错误处理和超时逻辑
    - _注：检索工具已通过 Go 后端 API，此服务保留作为备用_
    - _需求: 5.2, 10.1_
  
  - [x]* 2.4 为 VolcanoEmbeddingService 编写单元测试（可选）
    - 测试 embedding 生成
    - 测试批处理
    - 测试错误处理
    - _需求: 5.2_
  
  - [x]* 2.5 实现 WeaviateClient 包装器（可选 - 已通过 Go 后端）
    - 创建带连接池的客户端
    - 实现 search_similar 方法
    - 添加连接失败的错误处理
    - _注：检索工具已通过 Go 后端 API，此客户端保留作为备用_
    - _需求: 5.1, 5.5_
  
  - [x]* 2.6 为 WeaviateClient 编写单元测试（可选）
    - 测试向量搜索
    - 测试错误处理
    - 测试空结果处理
    - _需求: 5.1, 5.5_

- [-] 3. 实现 Tool 层（原子能力）
  - [x] 3.1 实现检索工具（已重构为调用 Go 后端 API）
    - 创建 SearchPRDTool（通过 Go 后端搜索 API）
    - 创建 SearchTestCaseTool（通过 Go 后端搜索 API）
    - 创建 GetRelatedCasesTool（通过 Go 后端推荐 API）
    - _注：已重构为调用 Go 后端，避免重复实现_
    - _需求: 5.1, 5.2, 5.5_
  
  - [ ]* 3.2 为检索工具编写属性测试（可选）
    - **属性 12: RAG 集成（通过 Go 后端）**
    - **验证: 需求 5.1**
  
  - [ ]* 3.3 为 embedding 生成编写属性测试（不需要）
    - ~~**属性 13: Embedding 生成**~~
    - _注：不再直接使用 embedding，已通过 Go 后端_
    - ~~**验证: 需求 5.2**~~
  
  - [ ]* 3.4 为最小检索数量编写属性测试（可选）
    - **属性 14: 最小检索数量（通过 Go 后端）**
    - **验证: 需求 5.5**
  
  - [x] 3.5 实现理解工具
    - 使用 LLM 创建 ParseRequirementTool
    - 创建用于测试点提取的 ExtractTestPointsTool
    - _需求: 4.1_
  
  - [x] 3.6 实现生成工具
    - 使用 LLM 创建 GenerateTestCaseTool
    - 创建用于结构格式化的 FormatTestCaseTool
    - _需求: 4.2, 4.4_
  
  - [x] 3.7 为测试用例结构编写属性测试
    - **属性 10: 测试用例结构完整性**
    - **验证: 需求 4.2**
  
  - [x] 3.8 为 JSON 输出格式编写属性测试
    - **属性 11: JSON 输出格式**
    - **验证: 需求 4.4**
  
  - [x] 3.9 实现验证工具
    - 创建用于覆盖率检查的 ValidateCoverageTool
    - 创建用于重复检测的 CheckDuplicationTool
    - 创建用于质量验证的 CheckQualityTool
    - _需求: 4.3_
  
  - [x] 3.10 实现存储工具
    - 创建通过 Go 后端 API 保存的 SaveTestCaseTool
    - 创建通过 Go 后端 API 更新的 UpdateTestCaseTool
    - _注：通过 Go 后端 API 保存，不直接连接数据库_
    - _需求: 8.4_
  
  - [x] 3.11 为测试用例持久化编写属性测试
    - **属性 17: 测试用例持久化往返**
    - **验证: 需求 8.4**

- [ ] 4. 检查点 - 确保所有工具测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 5. 实现 Subagent 层
  - [x] 5.1 实现 RequirementAnalysisAgent
    - 使用 LLM 和提示模板创建 agent
    - 实现用于需求提取的 analyze 方法
    - 添加结构化输出解析
    - _需求: 4.1_
  
  - [x] 5.2 为 RequirementAnalysisAgent 编写单元测试
    - 测试需求解析
    - 测试结构化输出
    - 测试错误处理
    - _需求: 4.1_
  
  - [x] 5.3 实现 TestDesignAgent
    - 使用 LLM 和提示模板创建 agent
    - 实现 design_tests 方法
    - 添加测试用例设计生成逻辑
    - _需求: 4.2, 4.3_
  
  - [x] 5.4 为 TestDesignAgent 编写单元测试
    - 测试测试用例生成
    - 测试不同场景类型的覆盖
    - 测试错误处理
    - _需求: 4.2, 4.3_
  
  - [x] 5.5 实现 QualityReviewAgent
    - 使用 LLM 和提示模板创建 agent
    - 实现用于质量检查的 review 方法
    - 添加覆盖率评分逻辑
    - _需求: 4.3_
  
  - [x] 5.6 为 QualityReviewAgent 编写单元测试
    - 测试质量评分
    - 测试问题检测
    - 测试批准/拒绝逻辑
    - _需求: 4.3_

- [ ] 6. 实现 Workflow 层（工作流编排）
  - [x] 6.1 实现 TestCaseGenerationWorkflow
    - 编排所有 subagents 和 tools 完成测试用例生成
    - 实现完整工作流（检索 → 分析 → 设计 → 审查 → 格式化）
    - 在每个步骤添加错误处理
    - _注：Workflow 是工作流编排器，负责协调多个 Agent 和 Tool_
    - _需求: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3_
  
  - [ ] 6.2 为测试用例生成编写属性测试
    - **属性 9: 测试用例生成**
    - **验证: 需求 4.1**
  
  - [ ] 6.3 为完整工作流编写集成测试
    - 测试端到端测试用例生成
    - 测试各种需求类型
    - 测试错误恢复
    - _需求: 4.1, 4.2, 4.3, 4.4_
  
  - [ ] 6.4 实现 ImpactAnalysisWorkflow
    - 创建用于影响分析的工作流
    - 实现变更分析流程编排
    - _需求: 5.1, 5.3_
  
  - [ ] 6.5 实现 RegressionRecommendationWorkflow
    - 创建用于回归测试推荐的工作流
    - 实现排名和推荐逻辑编排
    - _需求: 5.1_
  
  - [ ] 6.6 实现 TestCaseOptimizationWorkflow
    - 创建用于测试用例优化的工作流
    - 实现差距识别和补充生成流程
    - _需求: 4.3_

- [ ] 7. 实现 TestEngineerAgent（主 agent）
  - [ ] 7.1 使用 workflow 注册表创建 TestEngineerAgent
    - 使用 workflows 和 tools 实现 agent 初始化
    - 创建 workflow 发现和注册机制
    - _注：主 Agent 负责理解用户意图，选择合适的 Workflow 执行_
    - _需求: 2.6, 11.1, 11.2_
  
  - [ ] 7.2 为 workflow 可扩展性编写属性测试
    - **属性 4: Workflow 可扩展性**
    - **验证: 需求 2.6**
  
  - [ ] 7.3 为 workflow 自动发现编写属性测试
    - **属性 19: Workflow 自动发现**
    - **验证: 需求 11.2**
  
  - [ ] 7.4 实现任务分类逻辑
    - 添加将用户请求分类为任务类型的方法
    - 基于任务类型实现 workflow 选择
    - _需求: 4.1_
  
  - [ ] 7.5 实现 process_request 方法
    - 创建主请求处理工作流
    - 添加质量验证和错误处理
    - 实现响应格式化
    - _需求: 4.1, 4.4, 9.2_
  
  - [ ] 7.6 为结构化错误响应编写属性测试
    - **属性 18: 结构化错误响应**
    - **验证: 需求 9.2**

- [ ] 8. 实现 FastAPI 端点
  - [ ] 8.1 创建 /ai/generate 端点
    - 实现测试用例生成的 POST 处理器
    - 添加请求验证
    - 与 TestEngineerAgent 集成
    - 添加响应格式化
    - _需求: 2.3, 4.1, 4.4_
  
  - [ ] 8.2 为 SSE 创建 /ai/chat/stream 端点
    - 实现流式响应处理器
    - 添加 SSE 格式化
    - 与 BRConnector 流式传输集成
    - _需求: 7.1, 7.2_
  
  - [ ] 8.3 添加错误处理中间件
    - 创建全局错误处理器
    - 实现结构化错误响应
    - 为所有错误添加日志记录
    - _需求: 9.1, 9.2, 9.5_
  
  - [ ] 8.4 为 API 端点编写集成测试
    - 测试 /ai/generate 端点
    - 测试 /ai/chat/stream 端点
    - 测试错误响应
    - _需求: 2.3, 4.1, 7.1_

- [ ] 9. 检查点 - 确保 Python 服务完全正常运行
  - 确保所有测试通过，如有问题请询问用户。


- [ ] 10. 实现 Go 后端 AI 服务集成
  - [ ] 10.1 在 Go 中创建 AI 服务客户端
    - 使用 HTTP 客户端创建服务结构
    - 实现连接池
    - 添加指数退避的重试逻辑
    - _需求: 3.1, 3.2, 12.3_
  
  - [ ] 10.2 为 AI 服务客户端编写单元测试
    - 测试成功的请求
    - 测试重试逻辑
    - 测试超时处理
    - _需求: 3.1, 3.2_
  
  - [ ] 10.3 在 Go 中实现 AI handler
    - 使用依赖项创建 AIHandler 结构
    - 实现 Chat 端点处理器
    - 添加请求验证
    - _需求: 3.1, 3.3, 3.4_
  
  - [ ] 10.4 为请求验证编写属性测试
    - **属性 5: 请求验证和转发**
    - **验证: 需求 3.1**
  
  - [ ] 10.5 为响应处理编写属性测试
    - **属性 6: 响应处理**
    - **验证: 需求 3.2**
  
  - [ ] 10.4 实现流式端点处理器
    - 创建 SSE 流式处理器
    - 实现从 Python 服务的流转发
    - 添加流中断的错误处理
    - _需求: 7.2_
  
  - [ ] 10.5 为流转发编写属性测试
    - **属性 15: 流转发**
    - **验证: 需求 7.2**
  
  - [ ] 10.6 实现认证中间件
    - 为 AI 端点添加 JWT 验证
    - 实现授权检查
    - _需求: 3.4_
  
  - [ ] 10.7 为认证编写属性测试
    - **属性 7: 认证强制执行**
    - **验证: 需求 3.4**
  
  - [ ] 10.8 实现错误转换逻辑
    - 创建从 Python 服务错误的错误映射
    - 添加用户友好的错误消息
    - 实现错误日志记录
    - _需求: 3.5, 9.1, 9.3_
  
  - [ ] 10.9 为错误转换编写属性测试
    - **属性 8: 错误消息转换**
    - **验证: 需求 3.5**

- [ ] 11. 实现 Go 后端测试用例保存端点
  - [ ] 11.1 创建测试用例保存处理器
    - 实现 POST /api/ai/test-cases/save 端点
    - 为测试用例数据添加验证
    - 与现有测试用例服务集成
    - _需求: 8.3, 8.4_
  
  - [ ] 11.2 为测试用例保存编写属性测试
    - **属性 16: 测试用例保存触发器**
    - **验证: 需求 8.3**
  
  - [ ] 11.3 创建对话管理端点
    - 实现 GET /api/ai/conversations
    - 实现 DELETE /api/ai/conversations/:id
    - 添加对话持久化逻辑
    - _需求: 1.5_

- [ ] 12. 实现数据库迁移
  - 为 ai_conversations 表创建迁移
  - 为 ai_conversation_messages 表创建迁移
  - 为 ai_generated_test_cases 表创建迁移
  - 为 ai_generation_metadata 表创建迁移
  - 添加性能索引
  - _需求: 8.4, 9.1_

- [ ] 13. 更新 Go 后端路由器
  - 注册 AI handler 路由
  - 为 AI 路由添加认证中间件
  - 为 AI 端点配置 CORS
  - _需求: 3.3, 3.4_

- [ ] 14. 检查点 - 确保 Go 后端集成完成
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 15. 实现 React 前端 AI 对话页面
  - [ ] 15.1 创建 AIAssistant 页面组件
    - 使用对话界面创建页面结构
    - 实现消息状态管理
    - 添加输入字段和发送按钮
    - _需求: 1.1, 1.2_
  
  - [ ] 15.2 为页面渲染编写单元测试
    - 测试初始渲染
    - 测试 UI 元素存在
    - _需求: 1.1_
  
  - [ ] 15.3 为消息提交编写属性测试
    - **属性 1: 消息提交触发 API 调用**
    - **验证: 需求 1.2**
  
  - [ ] 15.4 实现消息显示逻辑
    - 创建消息列表组件
    - 添加基于角色的样式的消息渲染
    - 实现自动滚动到最新消息
    - _需求: 1.2, 1.4_
  
  - [ ] 15.5 为消息排序编写属性测试
    - **属性 3: 消息按时间顺序排列**
    - **验证: 需求 1.4**
  
  - [ ] 15.6 实现流式响应处理
    - 添加 SSE 连接逻辑
    - 实现流式文本的打字机效果
    - 添加加载状态
    - _需求: 1.3, 7.1, 7.3_
  
  - [ ] 15.7 为流式显示编写属性测试
    - **属性 2: 流式响应显示**
    - **验证: 需求 1.3**
  
  - [ ] 15.8 实现对话持久化
    - 为对话历史添加会话存储
    - 实现页面刷新时的对话加载
    - _需求: 1.5_
  
  - [ ] 15.9 为对话持久化编写单元测试
    - 测试会话存储
    - 测试对话加载
    - _需求: 1.5_

- [ ] 16. 实现 ChatBox 组件
  - 创建可重用的对话框组件
  - 实现带角色样式的消息气泡
  - 添加消息操作（复制、重新生成）
  - 添加时间戳显示
  - _需求: 1.1, 1.2, 1.3_

- [ ] 16.1 为 ChatBox 组件编写单元测试
  - 测试消息渲染
  - 测试操作按钮
  - 测试时间戳格式化
  - _需求: 1.1, 1.2_

- [ ] 17. 实现 TestCaseEditor 组件
  - [ ] 17.1 创建测试用例编辑器组件
    - 创建测试用例编辑表单
    - 实现字段验证
    - 添加步骤管理（添加/删除/重新排序）
    - _需求: 8.1, 8.2_
  
  - [ ] 17.2 实现保存功能
    - 添加带加载状态的保存按钮
    - 实现保存测试用例的 API 调用
    - 添加成功/错误通知
    - 成功后导航到测试用例详情
    - _需求: 8.3, 8.4, 8.5_
  
  - [ ] 17.3 为 TestCaseEditor 编写单元测试
    - 测试表单渲染
    - 测试字段验证
    - 测试保存功能
    - _需求: 8.1, 8.2, 8.3_

- [ ] 18. 实现 API 客户端函数
  - 创建用于对话 API 的 sendMessage 函数
  - 创建用于 SSE 的 streamMessage 函数
  - 创建 saveTestCases 函数
  - 创建 getConversations 函数
  - 添加错误处理和重试逻辑
  - _需求: 1.2, 7.1, 8.3_

- [ ] 18.1 为 API 客户端编写单元测试
  - 测试成功的 API 调用
  - 测试错误处理
  - 测试重试逻辑
  - _需求: 1.2, 7.1, 8.3_

- [ ] 19. 在前端实现错误处理
  - 添加全局错误边界
  - 实现错误通知
  - 为失败的请求添加重试机制
  - 创建用户友好的错误消息
  - _需求: 9.4_

- [ ] 19.1 为错误处理编写单元测试
  - 测试错误边界
  - 测试错误通知
  - 测试重试逻辑
  - _需求: 9.4_

- [ ] 20. 添加导航和路由
  - 在主导航中添加 AI 助手链接
  - 配置 /ai-assistant 页面的路由
  - 为认证添加路由守卫
  - _需求: 1.1, 3.4_

- [ ] 21. 检查点 - 确保前端完全正常运行
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 22. 集成和端到端测试
  - [ ] 22.1 设置测试环境
    - 配置测试数据库
    - 设置模拟 LLM 服务
    - 配置测试 Weaviate 实例
    - _需求: 12.1, 12.2_
  
  - [ ] 22.2 为完整工作流编写端到端测试
    - 测试用户输入 → AI 生成 → 保存 → 验证
    - 测试多种需求类型
    - 测试错误场景
    - _需求: 1.2, 4.1, 8.4_
  
  - [ ] 22.3 编写性能测试
    - 测试 10 秒内的响应时间
    - 测试并发请求处理（10+ 并发）
    - 测试 5 秒内的启动时间
    - _需求: 2.4, 2.5, 4.5, 12.1, 12.2_

- [ ] 23. 文档和部署准备
  - 为 Python AI 服务创建 README
  - 记录 API 端点和请求/响应格式
  - 为 Docker 创建部署指南
  - 添加环境变量文档
  - 创建故障排除指南
  - _需求: 10.1, 10.2, 10.5_

- [ ] 24. 最终检查点 - 完整系统验证
  - 运行所有测试（单元、属性、集成、端到端）
  - 验证所有需求都已满足
  - 在预发布环境中测试
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 所有任务对于全面的系统实施都是必需的
- 每个任务都引用特定需求以实现可追溯性
- 检查点确保在关键里程碑处进行增量验证
- 属性测试以最少 100 次迭代验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 实施遵循自下而上的方法：Tools → Subagents → Workflows → Main Agent → API → 前端
- Workflows 是工作流编排器，负责协调多个 Subagent 和 Tool 完成复杂业务流程
- 所有代码都应包含适当的错误处理和日志记录
- 配置应使用环境变量，永远不要硬编码 API 密钥
