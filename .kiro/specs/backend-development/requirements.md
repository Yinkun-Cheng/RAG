# RAG 测试用例管理系统 - 后端开发需求

## 1. 项目概述

### 1.1 项目背景
为前端页面提供完整的后端 API 支持，实现 PRD 文档和测试用例的管理、存储、检索功能，并为 Dify AI Agent 提供外部知识库接口。

### 1.2 技术栈
- **语言**: Go 1.21+
- **框架**: Gin
- **数据库**: PostgreSQL (结构化数据)
- **向量数据库**: Weaviate (语义检索)
- **ORM**: GORM
- **配置管理**: Viper
- **日志**: Zap

### 1.3 核心功能
1. 项目管理（多项目隔离）
2. 模块管理（树形结构）
3. PRD 文档管理（版本控制、Markdown 支持）
4. 测试用例管理（步骤管理、截图上传）
5. 标签管理
6. 语义检索（基于 Weaviate）
7. 影响分析（RAG + LLM）
8. Dify 外部知识库 API

## 2. 功能需求

### 2.1 项目管理

#### 2.1.1 项目 CRUD
- 创建项目（名称、描述）
- 获取项目列表
- 获取项目详情
- 更新项目信息
- 删除项目（级联删除所有关联数据）

#### 2.1.2 项目隔离
- 所有数据按 project_id 隔离
- API 请求需要指定 project_id
- 前端通过路由参数传递项目 ID

### 2.2 模块管理

#### 2.2.1 模块树结构
- 支持无限层级的树形结构
- 父子关系管理
- 排序功能

#### 2.2.2 模块 CRUD
- 创建模块（名称、描述、父模块）
- 获取模块树（完整树形结构）
- 更新模块信息
- 删除模块（级联删除子模块）

### 2.3 PRD 文档管理

#### 2.3.1 PRD 基础功能
- 创建 PRD（编号、标题、版本、App 版本、模块、内容、状态、作者）
- 获取 PRD 列表（分页、筛选、搜索）
- 获取 PRD 详情
- 更新 PRD
- 删除 PRD（软删除）

#### 2.3.2 PRD 版本管理
- 每次更新可选择创建新版本
- 版本历史记录
- 查看历史版本内容
- 版本对比

#### 2.3.3 PRD 状态管理
- 草稿（draft）
- 审核中（review）
- 已批准（approved）
- 已发布（published）
- 已归档（archived）

#### 2.3.4 PRD 同步状态
- 同步到向量数据库的状态
- 最后同步时间
- 同步失败重试

### 2.4 测试用例管理

#### 2.4.1 测试用例基础功能
- 创建测试用例（编号、标题、PRD 关联、模块、前置条件、预期结果、优先级、类型）
- 获取测试用例列表（分页、多维度筛选）
- 获取测试用例详情
- 更新测试用例
- 删除测试用例
- 批量删除

#### 2.4.2 测试步骤管理
- 动态添加/删除步骤
- 步骤排序
- 每个步骤包含：操作、测试数据、预期结果

#### 2.4.3 截图管理
- 上传截图（支持多文件）
- 截图与步骤关联
- 截图预览 URL
- 删除截图

#### 2.4.4 测试用例版本
- 版本历史记录
- 变更日志
- 完整快照（JSON 格式）

### 2.5 标签管理

#### 2.5.1 标签 CRUD
- 创建标签（名称、颜色、描述）
- 获取所有标签
- 更新标签
- 删除标签

#### 2.5.2 标签关联
- PRD 与标签多对多关联
- 测试用例与标签多对多关联
- 按标签筛选

### 2.6 文件上传

#### 2.6.1 截图上传
- 支持 PNG、JPG、JPEG、GIF
- 文件大小限制（10MB）
- 按日期组织存储路径
- 返回访问 URL

#### 2.6.2 文件管理
- 文件元数据存储
- 文件删除（物理删除）
- 孤立文件清理

### 2.7 语义检索

#### 2.7.1 Weaviate 集成
- 创建 Collection Schema
- PRD 文档向量化
- 测试用例向量化
- 自动同步机制

#### 2.7.2 检索功能
- 自然语言查询
- 类型筛选（PRD/测试用例/全部）
- 结构化过滤（模块、优先级、状态等）
- 相似度评分
- 结果高亮

#### 2.7.3 关联推荐
- 基于 PRD 推荐相关测试用例
- 基于测试用例推荐相关 PRD
- 相关性评分

### 2.8 影响分析

#### 2.8.1 版本对比
- PRD 版本内容对比
- 变更点识别
- 变更摘要生成

#### 2.8.2 影响评估
- 调用 LLM 分析变更影响
- 识别受影响的测试用例
- 影响程度评级（高/中/低）
- 生成更新建议

#### 2.8.3 测试用例建议
- 建议新增的测试用例
- 建议更新的测试用例
- 建议废弃的测试用例

### 2.9 Dify 集成

#### 2.9.1 外部知识库 API
- 符合 Dify 规范的检索接口
- 支持 top_k 和 score_threshold
- 返回格式化内容和元数据
- 项目级别的数据隔离

#### 2.9.2 元数据过滤
- 按 project_id 过滤
- 按类型过滤
- 按状态过滤
- 按优先级过滤

### 2.10 统计功能

#### 2.10.1 仪表盘数据
- 项目统计（PRD 数量、测试用例数量）
- 按优先级统计
- 按类型统计
- 按模块统计
- 按状态统计

#### 2.10.2 趋势分析
- 创建趋势
- 更新趋势
- 覆盖率统计

## 3. 非功能需求

### 3.1 性能要求
- 列表查询响应时间 < 500ms
- 详情查询响应时间 < 200ms
- 文件上传响应时间 < 2s
- 语义检索响应时间 < 1s
- 支持 1000+ PRD 文档
- 支持 10000+ 测试用例

### 3.2 数据一致性
- PostgreSQL 事务保证 ACID
- PostgreSQL 与 Weaviate 最终一致性
- 同步失败自动重试
- 数据校验机制

### 3.3 安全性
- 输入验证
- SQL 注入防护（GORM 自动处理）
- XSS 防护
- 文件类型验证
- 文件大小限制

### 3.4 可维护性
- 清晰的代码结构
- 完善的错误处理
- 详细的日志记录
- API 文档（Swagger）

### 3.5 可扩展性
- 模块化设计
- 接口抽象
- 配置化管理
- 支持水平扩展

## 4. API 设计原则

### 4.1 RESTful 规范
- 使用标准 HTTP 方法（GET、POST、PUT、DELETE）
- 资源命名使用复数形式
- URL 层级清晰
- 状态码规范使用

### 4.2 统一响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 4.3 错误处理
```json
{
  "code": 400,
  "message": "error message",
  "error": "detailed error"
}
```

### 4.4 分页规范
- 使用 page 和 page_size 参数
- 返回 total、page、page_size、items

### 4.5 筛选规范
- 使用查询参数
- 支持多条件组合
- 支持模糊搜索

## 5. 数据库设计要点

### 5.1 表设计
- 所有表包含 project_id（除 projects 表）
- 使用 UUID 作为主键
- 软删除支持（deleted_at）
- 时间戳字段（created_at、updated_at）

### 5.2 索引设计
- 外键字段建立索引
- 常用查询字段建立索引
- 唯一约束
- 复合索引优化

### 5.3 关系设计
- 项目与模块：一对多
- 项目与 PRD：一对多
- 项目与测试用例：一对多
- 模块与 PRD：多对一
- 模块与测试用例：多对一
- PRD 与测试用例：一对多
- PRD 与标签：多对多
- 测试用例与标签：多对多
- 测试用例与步骤：一对多
- 测试步骤与截图：一对多

## 6. 向量数据库设计

### 6.1 PRDDocument Collection
- 存储 PRD 完整元数据
- 包含 project_id、module_id、status、tags 等
- 支持结构化过滤

### 6.2 TestCase Collection
- 存储测试用例完整元数据
- 包含 project_id、prd_id、module_id、priority、type 等
- 支持结构化过滤

### 6.3 向量生成
- 使用 LLM API 生成 Embedding
- 或使用专门的 Embedding 模型
- 异步处理

## 7. 开发优先级

### P0（核心功能，必须完成）
1. 项目管理 API
2. 模块管理 API
3. PRD 文档 CRUD API
4. 测试用例 CRUD API
5. 测试步骤管理
6. 文件上传功能
7. 标签管理 API
8. 数据库迁移脚本

### P1（重要功能，优先完成）
1. PRD 版本管理
2. 测试用例版本管理
3. 语义检索功能
4. Weaviate 集成
5. 统计功能

### P2（增强功能，后续完成）
1. 影响分析功能
2. Dify 外部知识库 API
3. 批量操作
4. 数据导出

## 8. 验收标准

### 8.1 功能完整性
- ✅ 所有 P0 功能实现
- ✅ 所有 P1 功能实现
- ✅ API 与前端页面对接成功

### 8.2 质量标准
- ✅ 无严重 Bug
- ✅ 错误处理完善
- ✅ 日志记录完整
- ✅ 代码规范统一

### 8.3 性能标准
- ✅ 满足性能要求
- ✅ 数据库查询优化
- ✅ 索引配置合理

### 8.4 文档完整性
- ✅ API 文档完整
- ✅ 数据库文档完整
- ✅ 部署文档完整

## 9. 技术难点

### 9.1 多项目隔离
- 所有查询必须带 project_id
- 中间件统一处理
- 防止数据泄露

### 9.2 树形结构处理
- 递归查询优化
- 前端树形数据格式
- 级联删除处理

### 9.3 版本管理
- 版本号生成规则
- 版本内容快照
- 版本对比算法

### 9.4 文件上传
- 文件存储路径规划
- 文件访问权限
- 孤立文件清理

### 9.5 向量数据库同步
- 同步时机选择
- 失败重试机制
- 数据一致性保证

### 9.6 LLM 集成
- API 调用封装
- 错误处理
- 超时控制
- 成本控制

## 10. 开发计划

### 阶段 1：基础设施（2 天）
- 数据库迁移脚本
- GORM 模型定义
- 基础中间件（CORS、日志、错误处理）
- 响应格式封装

### 阶段 2：核心 API（3 天）
- 项目管理 API
- 模块管理 API
- 标签管理 API
- PRD 文档 CRUD API
- 测试用例 CRUD API

### 阶段 3：高级功能（2 天）
- 文件上传功能
- 版本管理
- 测试步骤管理
- 统计功能

### 阶段 4：RAG 功能（2 天）
- Weaviate 集成
- 向量化服务
- 语义检索 API
- 数据同步机制

### 阶段 5：增强功能（1 天）
- 影响分析
- Dify 集成
- 批量操作

### 阶段 6：测试与优化（1 天）
- 功能测试
- 性能优化
- Bug 修复
- 文档完善
