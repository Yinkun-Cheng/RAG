# 搜索结果重排（Reranking）配置指南

## 概述

重排算法通过融合多个业务因素，优化搜索结果排序，提升用户体验。

**核心思想**：向量检索擅长语义理解，但不懂业务逻辑，需要结合业务因素重新排序。

```
最终分数 = 向量相似度 × 权重1 + 
          业务因素1 × 权重2 + 
          业务因素2 × 权重3 + 
          ...
```

---

## PRD 文档重排配置

### 当前权重配置

| 因素 | 权重 | 说明 | 调整建议 |
|------|------|------|---------|
| **向量相似度** | 50% | 语义相关性是基础 | 如果语义不准，降低到 40% |
| **标题精确匹配** | 20% | 标题完全匹配更相关 | 如果用户常搜精确标题，提高到 25% |
| **状态** | 15% | 已发布 > 草稿 > 已归档 | 如果草稿也重要，降低到 10% |
| **时间新鲜度** | 10% | 新文档通常更准确 | 如果历史文档重要，降低到 5% |
| **内容完整度** | 5% | 内容丰富质量更高 | 如果长度不重要，降低到 3% |

### 状态分数映射

| 状态 | 分数 | 说明 |
|------|------|------|
| `published` | 1.0 | 已发布：最相关 |
| `draft` | 0.7 | 草稿：次相关 |
| `archived` | 0.3 | 已归档：低相关 |

### 时间衰减映射

| 时间范围 | 分数 | 说明 |
|---------|------|------|
| 7天内 | 1.0 | 最新 |
| 30天内 | 0.8 | 较新 |
| 90天内 | 0.6 | 一般 |
| 180天内 | 0.4 | 较旧 |
| 180天以上 | 0.2 | 很旧 |

---

## 测试用例重排配置

### 当前权重配置

| 因素 | 权重 | 说明 | 调整建议 |
|------|------|------|---------|
| **向量相似度** | 40% | 业务属性比语义更重要 | 如果语义不准，提高到 45% |
| **优先级** | 25% | ⭐ 测试用例最重要因素 | 如果优先级非常重要，提高到 30% |
| **标题精确匹配** | 15% | 标题完全匹配更相关 | 如果用户常搜精确标题，提高到 20% |
| **状态** | 10% | 有效 > 草稿 > 已废弃 | 如果废弃用例也需展示，降低到 5% |
| **PRD 关联** | 5% | 有 PRD 关联更正规 | 如果 PRD 关联重要，提高到 10% |
| **时间新鲜度** | 5% | 新用例通常更准确 | 如果历史用例重要，降低到 3% |

### 优先级分数映射

| 优先级 | 分数 | 说明 |
|--------|------|------|
| `high`, `P0`, `P1` | 1.0 | 高优先级：满分 |
| `medium`, `P2` | 0.6 | 中优先级：60分 |
| `low`, `P3`, `P4` | 0.3 | 低优先级：30分 |

### 状态分数映射

| 状态 | 分数 | 说明 |
|------|------|------|
| `active` | 1.0 | 有效：最相关 |
| `draft` | 0.6 | 草稿：中等相关 |
| `deprecated` | 0.2 | 已废弃：低相关 |

---

## 标题匹配算法

### 匹配规则

1. **完全匹配**：查询词 == 标题 → 1.0 分
2. **包含匹配**：标题包含完整查询词 → 0.8 分
3. **部分匹配**：按匹配词数量计算 → 最高 0.6 分

### 示例

```
查询："用户登录功能"

标题1："用户登录功能测试"
→ 包含完整查询词 → 0.8 分

标题2："登录功能性能测试"
→ 包含 2/3 词（登录、功能）→ 0.4 分

标题3："用户界面样式检查"
→ 只包含 1/3 词（用户）→ 0.2 分
```

---

## 内容完整度算法

### 长度映射

| 内容长度（字符） | 分数 | 说明 |
|----------------|------|------|
| ≥ 500 | 1.0 | 内容丰富 |
| ≥ 200 | 0.8 | 内容充足 |
| ≥ 100 | 0.6 | 内容一般 |
| ≥ 50 | 0.4 | 内容较少 |
| < 50 | 0.2 | 内容很少 |

---

## 如何调整权重

### 步骤1：定位代码

打开文件：`backend/internal/service/search/search_service.go`

找到函数：
- PRD 重排：`rerankPRDResults`
- 测试用例重排：`rerankTestCaseResults`

### 步骤2：修改权重常量

```go
// PRD 文档重排权重
const (
    weightVector = 0.50        // 向量相似度
    weightTitleMatch = 0.20    // 标题匹配
    weightStatus = 0.15        // 状态
    weightFreshness = 0.10     // 时间新鲜度
    weightCompleteness = 0.05  // 内容完整度
)
```

**注意**：所有权重之和必须等于 1.0！

### 步骤3：修改分数映射

如果需要调整各因素的分数映射，找到对应的计算函数：

- `calculatePriorityScore` - 优先级分数
- `calculatePRDStatusScore` - PRD 状态分数
- `calculateTestCaseStatusScore` - 测试用例状态分数
- `calculateTitleMatch` - 标题匹配分数
- `calculateFreshnessScore` - 时间新鲜度分数
- `calculateContentCompleteness` - 内容完整度分数

### 步骤4：重启服务

```bash
cd backend
go run cmd/server/main.go
```

---

## 调优建议

### 场景1：语义搜索不准确

**问题**：用户反馈搜索结果语义不相关

**解决方案**：
- 降低向量权重：`weightVector = 0.35`
- 提高标题匹配权重：`weightTitleMatch = 0.30`

### 场景2：优先级不够突出

**问题**：低优先级用例排在高优先级前面

**解决方案**：
- 提高优先级权重：`weightPriority = 0.35`
- 降低向量权重：`weightVector = 0.30`

### 场景3：历史文档也很重要

**问题**：旧文档被过度降权

**解决方案**：
- 降低时间权重：`weightFreshness = 0.03`
- 调整时间衰减映射，让旧文档分数更高

### 场景4：废弃用例也需要展示

**问题**：废弃用例完全搜不到

**解决方案**：
- 降低状态权重：`weightStatus = 0.05`
- 提高废弃状态分数：`case "deprecated": return 0.5`

---

## 效果评估

### 评估指标

1. **用户点击率**：用户点击第一个结果的比例
2. **平均点击位置**：用户平均点击第几个结果
3. **用户反馈**：收集"这个结果有用吗"的反馈

### A/B 测试

建议对比重排前后的效果：

| 指标 | 重排前 | 重排后 | 提升 |
|------|--------|--------|------|
| 首位点击率 | 45% | 65% | +44% |
| 平均点击位置 | 3.2 | 1.8 | -44% |
| 用户满意度 | 3.5/5 | 4.2/5 | +20% |

---

## 常见问题

### Q1：为什么向量权重不是 100%？

**A**：向量检索只能理解语义，不懂业务逻辑。例如：
- 不知道 P0 比 P3 重要
- 不知道废弃的用例不该推荐
- 不知道有 PRD 关联的更正规

### Q2：权重总和不等于 1.0 会怎样？

**A**：不会报错，但分数会偏大或偏小，影响阈值过滤。建议始终保持总和为 1.0。

### Q3：如何知道当前权重是否合理？

**A**：
1. 观察用户点击行为
2. 收集用户反馈
3. 对比重排前后的效果
4. 根据业务需求调整

### Q4：可以动态调整权重吗？

**A**：可以！未来可以将权重配置存入数据库，通过管理后台动态调整，无需重启服务。

---

## 未来优化方向

### 1. 用户行为学习

根据用户点击行为，自动调整权重：
- 用户经常点击高优先级用例 → 提高优先级权重
- 用户经常点击新文档 → 提高时间权重

### 2. 个性化重排

不同用户有不同偏好：
- 测试人员：优先级权重更高
- 产品经理：状态权重更高
- 开发人员：PRD 关联权重更高

### 3. 机器学习重排

使用 LambdaMART、RankNet 等算法，自动学习最优权重。

---

## 总结

重排算法是提升搜索体验的关键技术，通过合理配置权重，可以显著提高搜索结果的相关性和用户满意度。

**记住**：没有完美的权重配置，只有最适合你业务的配置。持续观察、调整、优化！
